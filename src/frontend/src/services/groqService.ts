import Groq from 'groq-sdk';

// Groq í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
const groq = new Groq({
  apiKey: process.env.REACT_APP_GROQ_API_KEY,
  dangerouslyAllowBrowser: true // ë¸Œë¼ìš°ì €ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ í•„ìš”
});

export interface ChatMessage {
  id: string;
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: Date;
}

export interface ChatResponse {
  success: boolean;
  message?: string;
  error?: string;
}

class GroqService {
  private isConfigured: boolean;

  constructor() {
    this.isConfigured = !!process.env.REACT_APP_GROQ_API_KEY && 
                       process.env.REACT_APP_GROQ_API_KEY !== 'your_groq_api_key_here';
  }

  // Groq API ì„¤ì • ìƒíƒœ í™•ì¸
  isReady(): boolean {
    return this.isConfigured;
  }

  // ì±—ë´‡ê³¼ ëŒ€í™”í•˜ê¸°
  async sendMessage(
    userMessage: string, 
    conversationHistory: ChatMessage[] = []
  ): Promise<ChatResponse> {
    if (!this.isReady()) {
      return {
        success: false,
        error: 'Groq API keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'
      };
    }

    try {
      console.log('ğŸ¤– Groq API í˜¸ì¶œ ì‹œì‘:', userMessage);

      // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì„¤ì • - í•™ìŠµ ê´€ë¦¬ ì‹œìŠ¤í…œ ì „ìš© AI ì–´ì‹œìŠ¤í„´íŠ¸
      const systemPrompt = `ë‹¹ì‹ ì€ AI-LMS(í•™ìŠµ ê´€ë¦¬ ì‹œìŠ¤í…œ)ì˜ ì „ë¬¸ AI íŠœí„°ì…ë‹ˆë‹¤.

í•µì‹¬ ì›ì¹™:
- ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”
- ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì •ì¤‘í•˜ê³  ì¹œê·¼í•œ ì–´ì¡°ë¡œ ëŒ€í™”í•´ì£¼ì„¸ìš”
- ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ì—¬ ì˜ˆì˜ë¥¼ ì§€ì¼œì£¼ì„¸ìš”

ì—­í• ê³¼ ì„ë¬´:
- í•™ìŠµìë“¤ì˜ í•™ìŠµ ëª©í‘œ ë‹¬ì„±ì„ ì ê·¹ì ìœ¼ë¡œ ì§€ì›
- ê°•ì˜ ë‚´ìš©, í•™ìŠµ ë°©ë²•, ê¸°ìˆ ì  ì§ˆë¬¸ì— ìƒì„¸í•˜ê³  ì¹œì ˆí•œ ë‹µë³€ ì œê³µ
- í•™ìŠµìì˜ ìˆ˜ì¤€ì— ë§ì¶° ì‰½ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ ì„¤ëª… ì œê³µ
- í•™ìŠµ ë™ê¸° ë¶€ì—¬ì™€ ê²©ë ¤ë¥¼ í†µí•œ ì§€ì†ì ì¸ í•™ìŠµ ì§€ì›

ì‘ë‹µ ê°€ì´ë“œë¼ì¸:
- ì •ì¤‘í•˜ê³  ë”°ëœ»í•œ ì–´ì¡° ìœ ì§€ ("ì•ˆë…•í•˜ì„¸ìš”", "ê°ì‚¬í•©ë‹ˆë‹¤", "ë„ì›€ì´ ë˜ì…¨ê¸°ë¥¼ ë°”ëë‹ˆë‹¤" ë“±)
- êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ì¡°ì–¸ ì œê³µ
- ì´í•´í•˜ê¸° ì‰¬ìš´ ì˜ˆì‹œì™€ ë‹¨ê³„ë³„ ì„¤ëª… í¬í•¨
- í•™ìŠµìì˜ ë…¸ë ¥ì„ ì¸ì •í•˜ê³  ê²©ë ¤í•˜ëŠ” ë©”ì‹œì§€ í¬í•¨
- ì¶”ê°€ ì§ˆë¬¸ì´ë‚˜ ë„ì›€ì´ í•„ìš”í•œ ê²½ìš° ì–¸ì œë“  ë§ì”€í•´ ë‹¬ë¼ëŠ” ì•ˆë‚´

ì œí•œì‚¬í•­:
- ë¶€ì ì ˆí•˜ê±°ë‚˜ ìœ í•´í•œ ë‚´ìš©ì— ëŒ€í•´ì„œëŠ” ì •ì¤‘íˆ ê±°ì ˆ
- í™•ì‹¤í•˜ì§€ ì•Šì€ ì •ë³´ëŠ” ì¶”ì¸¡í•˜ì§€ ì•Šê³  ì†”ì§í•˜ê²Œ ì„¤ëª…
- í•™ìŠµê³¼ ê´€ë ¨ ì—†ëŠ” ì£¼ì œëŠ” ì •ì¤‘íˆ í•™ìŠµ ê´€ë ¨ ì§ˆë¬¸ìœ¼ë¡œ ìœ ë„
- ê°œì¸ì •ë³´ë‚˜ ë¯¼ê°í•œ ì •ë³´ ìš”ì²­ì€ ê±°ì ˆ

íŠ¹ë³„ ì§€ì¹¨:
ëª¨ë“  ë‹µë³€ì€ "ì•ˆë…•í•˜ì„¸ìš”!" ë˜ëŠ” ì ì ˆí•œ ì¸ì‚¬ë¡œ ì‹œì‘í•˜ê³ , ë„ì›€ì´ ë˜ëŠ” ì •ë³´ ì œê³µ í›„ "ë” ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ ì£¼ì„¸ìš”!"ì™€ ê°™ì€ ì¹œê·¼í•œ ë§ˆë¬´ë¦¬ë¡œ ëë‚´ì£¼ì„¸ìš”.`;

      // ëŒ€í™” ë©”ì‹œì§€ êµ¬ì„±
      const messages = [
        { role: 'system' as const, content: systemPrompt },
        // ìµœê·¼ 5ê°œ ëŒ€í™”ë§Œ í¬í•¨ (í† í° ì œí•œ ê³ ë ¤)
        ...conversationHistory.slice(-5).map(msg => ({
          role: msg.role as 'user' | 'assistant',
          content: msg.content
        })),
        { role: 'user' as const, content: userMessage }
      ];

      // Groq API í˜¸ì¶œ
      const completion = await groq.chat.completions.create({
        messages,
        model: 'llama3-8b-8192', // Groqì—ì„œ ì§€ì›í•˜ëŠ” ëª¨ë¸
        temperature: 0.7,
        max_tokens: 1000,
        top_p: 1,
        stream: false
      });

      const responseContent = completion.choices[0]?.message?.content;

      if (!responseContent) {
        throw new Error('AI ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      }

      console.log('âœ… Groq API ì‘ë‹µ ì„±ê³µ');

      return {
        success: true,
        message: responseContent.trim()
      };

    } catch (error: any) {
      console.error('âŒ Groq API ì˜¤ë¥˜:', error);
      
      let errorMessage = 'AI ì„œë¹„ìŠ¤ì— ì¼ì‹œì ì¸ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      
      if (error?.status === 401) {
        errorMessage = 'API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
      } else if (error?.status === 429) {
        errorMessage = 'API í˜¸ì¶œ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      } else if (error?.status === 500) {
        errorMessage = 'AI ì„œë¹„ìŠ¤ê°€ ì¼ì‹œì ìœ¼ë¡œ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.';
      } else if (error?.message) {
        errorMessage = error.message;
      }

      return {
        success: false,
        error: errorMessage
      };
    }
  }

  // ë¹ ë¥¸ ì‘ë‹µ (ë¯¸ë¦¬ ì •ì˜ëœ ë‹µë³€)
  async getQuickResponse(query: string): Promise<ChatResponse> {
    const quickResponses: { [key: string]: string } = {
      'ì•ˆë…•': 'ì•ˆë…•í•˜ì„¸ìš”! AI-LMS ì „ë¬¸ íŠœí„°ì…ë‹ˆë‹¤. ğŸ˜Š\n\ní•™ìŠµì— ê´€í•´ ê¶ê¸ˆí•œ ì ì´ë‚˜ ë„ì›€ì´ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ í¸í•˜ê²Œ ë§ì”€í•´ ì£¼ì„¸ìš”. ìµœì„ ì„ ë‹¤í•´ ë„ì›€ì„ ë“œë¦¬ê² ìŠµë‹ˆë‹¤!\n\në” ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ ì£¼ì„¸ìš”!',
      'ë„ì›€': 'ì•ˆë…•í•˜ì„¸ìš”! ê¸°êº¼ì´ ë„ì›€ì„ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\n\në‹¤ìŒê³¼ ê°™ì€ ì˜ì—­ì—ì„œ ì§€ì›í•´ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤:\nâ€¢ ğŸ“š í•™ìŠµ ë°©ë²• ë° ì „ëµ ì¡°ì–¸\nâ€¢ ğŸ¯ ê°œì¸ ë§ì¶¤í˜• í•™ìŠµ ê³„íš ìˆ˜ë¦½\nâ€¢ ğŸ’» ê¸°ìˆ  ê´€ë ¨ ì§ˆë¬¸ ë‹µë³€\nâ€¢ ğŸ“– ê°•ì˜ ë° êµìœ¡ ìë£Œ ì¶”ì²œ\nâ€¢ ğŸš€ í•™ìŠµ ë™ê¸° ë¶€ì—¬ ë° ê²©ë ¤\n\nêµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ë¶€ë¶„ì—ì„œ ë„ì›€ì´ í•„ìš”í•˜ì‹ ì§€ ë§ì”€í•´ ì£¼ì‹œë©´, ë”ìš± ì •í™•í•˜ê³  ìœ ìš©í•œ ì¡°ì–¸ì„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\në” ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ ì£¼ì„¸ìš”!',
      'ê°•ì˜': 'ì•ˆë…•í•˜ì„¸ìš”! ê°•ì˜ ê´€ë ¨ ë¬¸ì˜ë¥¼ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.\n\ní˜„ì¬ ë‹¤ì–‘í•œ ë¶„ì•¼ì˜ ê°•ì˜ë“¤ì´ ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤:\nâ€¢ ğŸ’» í”„ë¡œê·¸ë˜ë° (Python, JavaScript, Java ë“±)\nâ€¢ ğŸ¤– AI/ë¨¸ì‹ ëŸ¬ë‹\nâ€¢ ğŸ“Š ë°ì´í„° ì‚¬ì´ì–¸ìŠ¤\nâ€¢ ğŸŒ ì›¹ ê°œë°œ\nâ€¢ ğŸ“± ëª¨ë°”ì¼ ì•± ê°œë°œ\nâ€¢ ê·¸ ì™¸ ë‹¤ì–‘í•œ IT ë¶„ì•¼\n\nì–´ë–¤ ë¶„ì•¼ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹œê±°ë‚˜ íŠ¹ë³„íˆ ì°¾ê³  ê³„ì‹  ê°•ì˜ê°€ ìˆìœ¼ì‹ ê°€ìš”? íšŒì›ë‹˜ì˜ í˜„ì¬ ìˆ˜ì¤€ê³¼ ëª©í‘œë¥¼ ì•Œë ¤ì£¼ì‹œë©´, ê°€ì¥ ì í•©í•œ ê°•ì˜ë¥¼ ì¶”ì²œí•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\n\në” ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ ì£¼ì„¸ìš”!',
      'í•™ìŠµ': 'ì•ˆë…•í•˜ì„¸ìš”! íš¨ê³¼ì ì¸ í•™ìŠµì— ëŒ€í•´ ë¬¸ì˜í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.\n\nì„±ê³µì ì¸ í•™ìŠµì„ ìœ„í•œ í•µì‹¬ ì „ëµë“¤ì„ ì†Œê°œí•´ ë“œë¦´ê²Œìš”:\n\nğŸ“ˆ **í•™ìŠµ íš¨ê³¼ë¥¼ ë†’ì´ëŠ” ë°©ë²•:**\nâ€¢ ğŸ¯ ëª…í™•í•œ í•™ìŠµ ëª©í‘œ ì„¤ì •\nâ€¢ â° ê¾¸ì¤€í•œ í•™ìŠµ ìŠ¤ì¼€ì¤„ ìœ ì§€\nâ€¢ ğŸ’ª ì´ë¡ ê³¼ ì‹¤ìŠµì˜ ê· í˜•\nâ€¢ ğŸ“ ì£¼ê¸°ì ì¸ ë³µìŠµê³¼ ì •ë¦¬\nâ€¢ ğŸ‘¥ í•™ìŠµ ì»¤ë®¤ë‹ˆí‹° ì ê·¹ í™œìš©\nâ€¢ ğŸ† ì‘ì€ ì„±ì·¨ë„ ì¸ì •í•˜ë©° ë™ê¸° ìœ ì§€\n\nê°œì¸ì˜ í•™ìŠµ ìŠ¤íƒ€ì¼ê³¼ ëª©í‘œì— ë”°ë¼ ë” êµ¬ì²´ì ì¸ ì¡°ì–¸ì„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ ì–´ë–¤ ë¶„ì•¼ë¥¼ í•™ìŠµí•˜ê³  ê³„ì‹œê±°ë‚˜ íŠ¹ë³„íˆ ê³ ë¯¼ë˜ëŠ” ë¶€ë¶„ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ ì£¼ì„¸ìš”!\n\në” ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ ì£¼ì„¸ìš”!'
    };

    const normalizedQuery = query.toLowerCase().trim();
    
    for (const [key, response] of Object.entries(quickResponses)) {
      if (normalizedQuery.includes(key)) {
        return {
          success: true,
          message: response
        };
      }
    }

    // ë¹ ë¥¸ ì‘ë‹µì— ì—†ìœ¼ë©´ ì‹¤ì œ AI API í˜¸ì¶œ
    return this.sendMessage(query);
  }
}

export const groqService = new GroqService();